{% extends "base.html" %}

{% block content %}
<head>
    <title>Voting View</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Voting View</h1>

        <!-- Filter Dropdown -->
        <div class="filter-container">
            <label for="filter">Sort by:</label>
            <select id="filter" onchange="applyFilter()">
                <option value="newest" {% if filter_type == 'newest' %}selected{% endif %}>Newest</option>
                <option value="trending" {% if filter_type == 'trending' %}selected{% endif %}>Trending</option>
                <option value="status" {% if filter_type == 'status' %}selected{% endif %}>Status</option>
            </select>
        </div>

        <!-- Suggestions Card View -->
        <div class="card-container">
            {% for suggestion in suggestions %}
            <div class="suggestion-card" data-index="{{ loop.index0 }}" data-id="{{ suggestion.SuggestionID }}">
                <div class="card-header">
                    <h3>{{ suggestion.Description }}</h3>
                    <p class="status-label status-{{ suggestion.StatusName | lower | replace(' ', '-') }}">
                        Status: <span id="status-{{ suggestion.SuggestionID }}">{{ suggestion.StatusName or "Unknown" }}</span>
                    </p>
                </div>
                <div class="card-body">
                    <p><strong>Comments:</strong> {{ suggestion.Comments }}</p>
                    <p><strong>Created Date:</strong> {{ suggestion.CreatedDate }}</p>

                    <!-- Voting Section -->
                    <div class="vote-buttons">
                        <button class="upvote {% if suggestion.UserVote == 1 %}voted{% endif %}" 
                            id="upvote-btn-{{ suggestion.SuggestionID }}" 
                            onclick="castVote('{{ suggestion.SuggestionID }}', 'upvote')">
                            üëç <span id="upvote-{{ suggestion.SuggestionID }}">{{ suggestion.PositiveVote or 0 }}</span>
                        </button>
                        
                        <button class="downvote {% if suggestion.UserVote == 0 %}voted{% endif %}" 
                            id="downvote-btn-{{ suggestion.SuggestionID }}" 
                            onclick="castVote('{{ suggestion.SuggestionID }}', 'downvote')">
                            üëé <span id="downvote-{{ suggestion.SuggestionID }}">{{ suggestion.NegativeVote or 0 }}</span>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Vote Confirmation Message -->
    <div id="vote-confirmation" class="vote-confirmation hidden">Your vote has been recorded!</div>

    <!-- Lightbox Modal -->
    <div id="suggestionModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">‚úñ</button>
            <h2 id="modalTitle"></h2>
            <p id="modalDescription"></p>
            <p id="modalComments"></p>
            <p><strong>Status:</strong> <span id="modalStatus"></span></p>

            <!-- Voting in Lightbox -->
            <div class="modal-vote-buttons">
                <button class="upvote" onclick="castVoteFromModal('upvote')">üëç 
                    <span id="modalUpvoteCount">0</span>
                </button>
                <button class="downvote" onclick="castVoteFromModal('downvote')">üëé 
                    <span id="modalDownvoteCount">0</span>
                </button>
            </div>

            <div class="modal-navigation">
                <button onclick="prevSuggestion()">‚Üê Previous</button>
                <button onclick="nextSuggestion()">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Store JSON Data in Hidden Div -->
    <div id="suggestion-data" data-suggestions='{{ suggestions | tojson | safe }}'></div>

    <script>
        let suggestions = JSON.parse(document.getElementById("suggestion-data").dataset.suggestions);
        let currentIndex = 0;

        // Apply filter selection
        function applyFilter() {
            let selectedFilter = document.getElementById("filter").value;
            window.location.href = "/voting_view?filter=" + selectedFilter;
        }

        // Attach click event to open modal
        document.querySelectorAll(".suggestion-card").forEach((card) => {
            card.addEventListener("click", function () {
                let index = parseInt(card.dataset.index);
                openModal(index);
            });
        });

        function openModal(index) {
            currentIndex = index;
            updateModal();
            document.getElementById("suggestionModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("suggestionModal").style.display = "none";
        }

        function updateModal() {
            if (suggestions.length > 0) {
                let currentSuggestion = suggestions[currentIndex];
                document.getElementById("modalTitle").innerText = currentSuggestion.Description;
                document.getElementById("modalDescription").innerText = "Comments: " + (currentSuggestion.Comments || "None");
                document.getElementById("modalStatus").innerText = currentSuggestion.StatusName || "Unknown";
                document.getElementById("modalUpvoteCount").innerText = currentSuggestion.PositiveVote || 0;
                document.getElementById("modalDownvoteCount").innerText = currentSuggestion.NegativeVote || 0;
            }
        }

        function prevSuggestion() {
            if (currentIndex > 0) {
                currentIndex--;
                updateModal();
            }
        }

        function nextSuggestion() {
            if (currentIndex < suggestions.length - 1) {
                currentIndex++;
                updateModal();
            }
        }

        function castVote(suggestionId, voteType) {
            fetch('/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ 'suggestion_id': suggestionId, 'vote_type': voteType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                    return;
                }

                // Store vote selection
                localStorage.setItem(`voted-${suggestionId}`, voteType);

                // Update UI instantly
                document.getElementById(`upvote-${suggestionId}`).innerText = data.new_upvotes;
                document.getElementById(`downvote-${suggestionId}`).innerText = data.new_downvotes;
                document.getElementById(`status-${suggestionId}`).innerText = data.new_status;

                // Highlight the selected vote button
                document.getElementById(`upvote-btn-${suggestionId}`).classList.toggle("voted", voteType === 'upvote');
                document.getElementById(`downvote-btn-${suggestionId}`).classList.toggle("voted", voteType === 'downvote');

                // Show confirmation message
                let confirmation = document.getElementById("vote-confirmation");
                confirmation.classList.remove("hidden");

                // Reload after 1 second
                setTimeout(() => {
                    confirmation.classList.add("hidden");
                }, 1000);
            })
            .catch(error => console.error('Error:', error));
        }

        function castVoteFromModal(voteType) {
            let suggestionId = suggestions[currentIndex].SuggestionID;
            castVote(suggestionId, voteType);
        }

        // Highlight user's previous vote
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".suggestion-card").forEach((card) => {
                let suggestionId = card.dataset.id;
                let votedType = localStorage.getItem(`voted-${suggestionId}`);

                if (votedType === 'upvote') {
                    document.getElementById(`upvote-btn-${suggestionId}`).classList.add("voted");
                } else if (votedType === 'downvote') {
                    document.getElementById(`downvote-btn-${suggestionId}`).classList.add("voted");
                }
            });
        });
    </script>
</body>
{% endblock %}